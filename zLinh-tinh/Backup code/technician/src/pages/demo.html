<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng D·ª•ng KTV - Demo</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- T·∫£i Font Awesome cho c√°c bi·ªÉu t∆∞·ª£ng -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Lo·∫°i b·ªè hi·ªáu ·ª©ng highlight khi ch·∫°m tr√™n di ƒë·ªông */
        }
        .screen {
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n t·∫•t c·∫£ m√†n h√¨nh */
        }
        .screen.active {
            display: block; /* Hi·ªÉn th·ªã m√†n h√¨nh ƒëang ho·∫°t ƒë·ªông */
        }
        /* Style cho th√¥ng b√°o t·∫°m th·ªùi */
        #temp-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Cho ph√©p click xuy√™n qua */
        }
        #temp-notification.show {
            opacity: 1;
        }
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 0;
        }
        .collapsible-content.expanded {
            max-height: 500px; /* Adjust as needed */
            transition: max-height 0.5s ease-in;
        }
        /* Style cho c√°c input/textarea b·ªã disabled */
        input:disabled, textarea:disabled, button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background-color: #e2e8f0; /* bg-gray-200 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header Chung -->
    <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center z-10">
        <button id="back-button" class="hidden text-xl p-2 rounded-full hover:bg-blue-700 transition-colors">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1 id="header-title" class="text-xl font-bold flex-grow text-center">L·ªãch L√†m Vi·ªác</h1>
        <div class="w-8"></div> <!-- Gi·ªØ kho·∫£ng tr·ªëng ƒë·ªÉ cƒÉn gi·ªØa ti√™u ƒë·ªÅ -->
    </header>

    <!-- C√°c M√†n H√¨nh Ch√≠nh -->
    <main class="flex-grow p-4 overflow-auto">

        <!-- M√†n h√¨nh L·ªãch l√†m vi·ªác üìÖ -->
        <section id="schedule-screen" class="screen active">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">C√°c C√¥ng Vi·ªác ƒê∆∞·ª£c Giao</h2>

            <!-- T·ªïng h√≥a ch·∫•t c·∫ßn l·∫•y trong ng√†y -->
            <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                <div id="chemicals-summary-header" class="collapsible-header text-lg font-semibold text-gray-800 mb-2">
                    T·ªïng H√≥a Ch·∫•t C·∫ßn L·∫•y Trong Ng√†y <span id="daily-chemicals-status-text" class="text-sm font-normal text-gray-500 ml-2">(Ch∆∞a x√°c nh·∫≠n)</span> <i class="fas fa-chevron-down ml-2"></i>
                </div>
                <div id="chemicals-summary-content" class="collapsible-content">
                    <div id="daily-chemicals-list" class="mb-4">
                        <!-- Danh s√°ch h√≥a ch·∫•t t·ªïng h·ª£p s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
                        <p class="text-gray-600">Kh√¥ng c√≥ h√≥a ch·∫•t c·∫ßn l·∫•y trong ng√†y n√†y.</p>
                    </div>

                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="chemicals-collected-checkbox" class="form-checkbox h-5 w-5 text-green-600 rounded focus:ring-green-500">
                        <label for="chemicals-collected-checkbox" class="ml-3 text-gray-700 font-medium">ƒê√£ x√°c nh·∫≠n l·∫•y ƒë·ªß h√≥a ch·∫•t</label>
                    </div>
                    <div id="chemicals-notes-container" class="hidden">
                        <label for="chemicals-collection-notes" class="block text-gray-700 text-sm font-bold mb-2">Ghi ch√∫ (n·∫øu kh√¥ng ƒë·ªß):</label>
                        <textarea id="chemicals-collection-notes" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all resize-y" rows="2" placeholder="Ghi ch√∫ n·∫øu c√≥ h√≥a ch·∫•t kh√¥ng ƒë·ªß ho·∫∑c c√°c v·∫•n ƒë·ªÅ kh√°c..."></textarea>
                    </div>
                    <button id="save-daily-chemicals-status" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg transition-colors shadow-md mt-4">
                        L∆∞u Tr·∫°ng Th√°i H√≥a Ch·∫•t
                    </button>
                </div>
            </div>

            <!-- Danh s√°ch c√¥ng vi·ªác -->
            <div id="job-list" class="space-y-3">
                <!-- C√°c m·ª•c c√¥ng vi·ªác s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
            </div>
        </section>

        <!-- M√†n h√¨nh B√°o c√°o C√¥ng t√°c Hi·ªán tr∆∞·ªùng üìù (bao g·ªìm c·∫£ Chi ti·∫øt c√¥ng vi·ªác) -->
        <section id="report-screen" class="screen">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4" id="report-screen-title">Chi Ti·∫øt C√¥ng Vi·ªác</h2>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <!-- Th√¥ng tin Chi ti·∫øt c√¥ng vi·ªác -->
                <p class="text-gray-600 mb-2"><strong class="text-gray-800">M√£ CV:</strong> <span id="report-job-id"></span></p>
                <p class="text-gray-600 mb-2"><strong class="text-gray-800">Kh√°ch h√†ng:</strong> <span id="report-customer-name-detail"></span></p>
                <p class="text-gray-600 mb-2"><strong class="text-gray-800">ƒê·ªãa ch·ªâ:</strong> <span id="report-address-detail"></span></p>
                <p class="text-gray-600 mb-2"><strong class="text-gray-800">N·ªôi dung:</strong> <span id="report-content-detail"></span></p>
                <p class="text-gray-600 mb-2"><strong class="text-gray-800">Ng∆∞·ªùi li√™n h·ªá:</strong> <span id="report-contact-person"></span></p>
                <p class="text-gray-600 mb-4 flex items-center flex-wrap">
                    <strong class="text-gray-800 mr-2">S·ªë ƒëi·ªán tho·∫°i:</strong> <span id="report-contact-phone"></span>
                    <div class="flex space-x-2 mt-2 sm:mt-0 ml-0 sm:ml-2">
                        <button id="call-phone-button" class="px-2 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded-md transition-colors shadow-sm flex items-center">
                            <i class="fas fa-phone-alt mr-1"></i> G·ªçi
                        </button>
                        <button id="zalo-phone-button" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-md transition-colors shadow-sm flex items-center">
                            <i class="fas fa-comment-dots mr-1"></i> Zalo
                        </button>
                    </div>
                </p>
                <p class="text-gray-600 mb-4"><strong class="text-gray-800">Y√™u c·∫ßu ƒë·∫∑c bi·ªát:</strong> <span id="report-special-requests"></span></p>

                <!-- Checklist c√¥ng vi·ªác th·ª±c hi·ªán (Xem tr∆∞·ªõc) -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Checklist c√¥ng vi·ªác th·ª±c hi·ªán:</label>
                    <ul id="report-detail-checklist" class="list-disc list-inside text-gray-700 space-y-1 pl-4">
                        <!-- Checklist items will be loaded here -->
                    </ul>
                </div>

                <!-- H√≥a ch·∫•t c·∫ßn chu·∫©n b·ªã (Xem tr∆∞·ªõc) -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">H√≥a ch·∫•t c·∫ßn chu·∫©n b·ªã:</label>
                    <ul id="report-required-chemicals" class="list-disc list-inside text-gray-700 space-y-1 pl-4">
                        <!-- Required chemicals will be loaded here -->
                    </ul>
                </div>

                <!-- N√∫t B·∫Øt ƒë·∫ßu c√¥ng vi·ªác (Ch·ªâ hi·ªÉn th·ªã khi pending) -->
                <button id="start-job-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition-colors shadow-md mb-6">
                    B·∫Øt ƒê·∫ßu C√¥ng Vi·ªác (Check-in)
                </button>

                <!-- C√°c ph·∫ßn c·ªßa B√°o c√°o C√¥ng t√°c (ch·ªâ t∆∞∆°ng t√°c khi checkedIn ho·∫∑c checkedOut) -->
                <div id="report-edit-area">
                    <hr class="my-6 border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Nh·∫≠p B√°o C√°o Hi·ªán Tr∆∞·ªùng</h3>

                    <!-- Ghi ch√∫ -->
                    <div class="mb-6">
                        <label for="notes" class="block text-gray-700 text-sm font-bold mb-2">Ghi ch√∫ / Khuy·∫øn c√°o:</label>
                        <div class="relative">
                            <textarea id="notes" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all resize-y" rows="4" placeholder="Nh·∫≠p ghi ch√∫ ho·∫∑c khuy·∫øn c√°o..."></textarea>
                            <button id="microphone-button" class="absolute bottom-2 right-2 bg-blue-500 text-white p-2 rounded-full shadow-md hover:bg-blue-600 transition-colors" title="Nh·∫≠p li·ªáu b·∫±ng gi·ªçng n√≥i (ch·ª©c nƒÉng demo)">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Ch·ª•p v√† ƒë√≠nh k√®m h√¨nh ·∫£nh -->
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">H√¨nh ·∫£nh hi·ªán tr∆∞·ªùng:</label>
                        <input type="file" id="image-upload" accept="image/*" class="hidden">
                        <button id="upload-image-button" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg transition-colors flex items-center justify-center shadow-md">
                            <i class="fas fa-camera mr-2"></i> Ch·ª•p / ƒê√≠nh k√®m ·∫£nh (T·ªëi ∆∞u t·ª± ƒë·ªông)
                        </button>
                        <div id="image-preview-container" class="mt-4 grid grid-cols-3 gap-2">
                            <!-- ·∫¢nh xem tr∆∞·ªõc s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                        </div>
                    </div>

                    <!-- Checklist c√¥ng vi·ªác (ƒë√°nh d·∫•u) -->
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Checklist c√¥ng vi·ªác:</label>
                        <div id="checklist" class="space-y-2">
                            <!-- C√°c m·ª•c checklist s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
                        </div>
                    </div>

                    <!-- B√°o c√°o h√≥a ch·∫•t v√† v·∫≠t t∆∞ s·ª≠ d·ª•ng -->
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">B√°o c√°o h√≥a ch·∫•t v√† v·∫≠t t∆∞ ƒë√£ s·ª≠ d·ª•ng:</label>
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    <th class="py-3 px-4 border-b">Lo·∫°i H√≥a Ch·∫•t/V·∫≠t T∆∞</th>
                                    <th class="py-3 px-4 border-b text-right">S·ªë L∆∞·ª£ng Y√™u C·∫ßu</th>
                                    <th class="py-3 px-4 border-b text-right">S·ªë L∆∞·ª£ng Th·ª±c T·∫ø</th>
                                    <th class="py-3 px-4 border-b text-center">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="material-report-body" class="divide-y divide-gray-200">
                                <!-- C√°c h√†ng v·∫≠t t∆∞ s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="p-4 text-center">
                                        <button id="add-material-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">
                                            <i class="fas fa-plus mr-1"></i> Th√™m H√≥a Ch·∫•t/V·∫≠t T∆∞ Kh√°c
                                        </button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- N√∫t L∆∞u B√°o C√°o -->
                    <button id="save-report-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition-colors shadow-md mb-3">
                        <i class="fas fa-save mr-2"></i> L∆∞u B√°o C√°o
                    </button>

                    <!-- N√∫t Check-out -->
                    <button id="checkout-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg transition-colors shadow-md">
                        K·∫øt Th√∫c C√¥ng Vi·ªác (Check-out)
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- Modal t√πy ch·ªânh cho th√¥ng b√°o (thay th·∫ø alert()) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4 text-gray-800" id="modal-title">Th√¥ng b√°o</h3>
            <p id="modal-message" class="mb-6 text-gray-700"></p>
            <button id="modal-close-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                ƒê√≥ng
            </button>
        </div>
    </div>

    <!-- Th√¥ng b√°o copy t·∫°m th·ªùi -->
    <div id="temp-notification"></div>

    <script>
        // H√†m l·∫•y ng√†y hi·ªán t·∫°i ·ªü ƒë·ªãnh d·∫°ng YYYY-MM-DD
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Th√°ng b·∫Øt ƒë·∫ßu t·ª´ 0
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Data m·∫´u cho c√°c c√¥ng vi·ªác
        const jobs = [
            {
                id: 'CV001',
                customerName: 'C√¥ng ty TNHH ABC',
                address: '123 ƒê∆∞·ªùng Nguy·ªÖn Hu·ªá, Q1, TP.HCM',
                content: 'Ki·ªÉm tra, b·∫£o tr√¨ h·ªá th·ªëng ƒëi·ªÅu h√≤a',
                specialRequests: 'Mang theo d·ª•ng c·ª• ki·ªÉm tra √°p su·∫•t.',
                contactPerson: 'Ch·ªã Lan',
                contactPhone: '0901234567',
                scheduledDate: getTodayDate(), // ƒê·∫∑t ng√†y h√¥m nay
                scheduledTime: '08:00 - 10:00',
                requiredChemicals: [
                    { name: 'Ga l·∫°nh R410A', quantity: 1.5, unit: 'kg' },
                    { name: 'Ch·∫•t t·∫©y r·ª≠a d√†n l·∫°nh', quantity: 0.5, unit: 'l√≠t' }
                ],
                checklistItems: [
                    'Ki·ªÉm tra √°p su·∫•t gas',
                    'V·ªá sinh l∆∞·ªõi l·ªçc',
                    'Ki·ªÉm tra ·ªëng tho√°t n∆∞·ªõc'
                ]
            },
            {
                id: 'CV002',
                customerName: 'C·ª≠a h√†ng XYZ',
                address: '456 ƒê∆∞·ªùng Tr·∫ßn H∆∞ng ƒê·∫°o, Q5, TP.HCM',
                content: 'Di·ªát c√¥n tr√πng ƒë·ªãnh k·ª≥',
                specialRequests: 'C·∫©n th·∫≠n v·ªõi v·∫≠t nu√¥i trong nh√†.',
                contactPerson: 'Anh B√¨nh',
                contactPhone: '0908765432',
                scheduledDate: getTodayDate(), // ƒê·∫∑t ng√†y h√¥m nay
                scheduledTime: '10:30 - 12:00',
                requiredChemicals: [
                    { name: 'Thu·ªëc di·ªát mu·ªói', quantity: 1, unit: 'l√≠t' },
                    { name: 'Thu·ªëc di·ªát gi√°n', quantity: 200, unit: 'gram' }
                ],
                checklistItems: [
                    'Phun thu·ªëc di·ªát mu·ªói khu v·ª±c trong nh√†',
                    'ƒê·∫∑t b·∫´y gi√°n t·∫°i b·∫øp',
                    'Ki·ªÉm tra c√°c khe h·ªü'
                ]
            },
            {
                id: 'CV003',
                customerName: 'Nh√† ri√™ng Anh Tu·∫•n',
                address: '789 ƒê∆∞·ªùng L√™ L·ª£i, Q3, TP.HCM',
                content: 'S·ª≠a ch·ªØa ƒëi·ªán n∆∞·ªõc',
                specialRequests: 'Mang theo thang cao.',
                contactPerson: 'Anh Tu·∫•n',
                contactPhone: '0912345678',
                scheduledDate: '2025-08-16', // Ng√†y kh√°c ƒë·ªÉ minh h·ªça
                scheduledTime: '14:00 - 16:00',
                requiredChemicals: [],
                checklistItems: [
                    'Ki·ªÉm tra r√≤ r·ªâ ƒë∆∞·ªùng ·ªëng n∆∞·ªõc',
                    'S·ª≠a ch·ªØa ·ªï c·∫Øm ƒëi·ªán b·ªã h·ªèng'
                ]
            }
        ];

        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
        const scheduleScreen = document.getElementById('schedule-screen');
        const reportScreen = document.getElementById('report-screen');
        const jobList = document.getElementById('job-list');
        const headerTitle = document.getElementById('header-title');
        const backButton = document.getElementById('back-button');

        const reportScreenTitle = document.getElementById('report-screen-title');
        const reportJobId = document.getElementById('report-job-id');
        const reportCustomerNameDetail = document.getElementById('report-customer-name-detail');
        const reportAddressDetail = document.getElementById('report-address-detail');
        const reportContentDetail = document.getElementById('report-content-detail');
        const reportContactPerson = document.getElementById('report-contact-person');
        const reportContactPhone = document.getElementById('report-contact-phone');
        const callPhoneButton = document.getElementById('call-phone-button');
        const zaloPhoneButton = document.getElementById('zalo-phone-button');
        const reportSpecialRequests = document.getElementById('report-special-requests');
        const reportDetailChecklist = document.getElementById('report-detail-checklist');
        const reportRequiredChemicals = document.getElementById('report-required-chemicals');
        const startJobButton = document.getElementById('start-job-button');

        const reportEditArea = document.getElementById('report-edit-area');
        const notesTextarea = document.getElementById('notes');
        const microphoneButton = document.getElementById('microphone-button');
        const uploadImageButton = document.getElementById('upload-image-button');
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const checklistDiv = document.getElementById('checklist');
        const materialReportBody = document.getElementById('material-report-body');
        const addMaterialButton = document.getElementById('add-material-button');
        const saveReportButton = document.getElementById('save-report-button');
        const checkoutButton = document.getElementById('checkout-button');

        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');

        const tempNotification = document.getElementById('temp-notification');

        const chemicalsSummaryHeader = document.getElementById('chemicals-summary-header');
        const chemicalsSummaryContent = document.getElementById('chemicals-summary-content');
        const dailyChemicalsList = document.getElementById('daily-chemicals-list');
        const chemicalsCollectedCheckbox = document.getElementById('chemicals-collected-checkbox');
        const chemicalsCollectionNotes = document.getElementById('chemicals-collection-notes');
        const chemicalsNotesContainer = document.getElementById('chemicals-notes-container');
        const saveDailyChemicalsStatusButton = document.getElementById('save-daily-chemicals-status');
        const dailyChemicalsStatusText = document.getElementById('daily-chemicals-status-text'); // NEW

        let currentJob = null;
        let jobStatus = {};
        // L∆∞u tr·ªØ tr·∫°ng th√°i t·ªïng h√≥a ch·∫•t theo ng√†y
        // M·ªói ng√†y c√≥ th·ªÉ ·ªü tr·∫°ng th√°i 'pending' (ch∆∞a x√°c nh·∫≠n) ho·∫∑c 'confirmed' (ƒë√£ x√°c nh·∫≠n)
        let dailyChemicalsStatus = {
            // '2025-08-15': { status: 'pending', notes: '' }
        };

        // --- H√†m Utility ---

        function showCustomModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            customModal.classList.remove('hidden');
        }

        modalCloseButton.addEventListener('click', () => {
            customModal.classList.add('hidden');
        });

        let notificationTimeout;
        function showTempNotification(message) {
            tempNotification.textContent = message;
            tempNotification.classList.add('show');
            clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => {
                tempNotification.classList.remove('show');
            }, 1000);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            if (screenId === 'schedule-screen') {
                headerTitle.textContent = 'L·ªãch L√†m Vi·ªác';
                backButton.classList.add('hidden');
            } else if (screenId === 'report-screen') {
                // Title set by initializeReportScreen
                backButton.classList.remove('hidden');
            }
        }

        function copyToClipboard(text, message = 'ƒê√£ copy v√†o b·ªô nh·ªõ t·∫°m') {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showTempNotification(message);
                } else {
                    showCustomModal('Copy Th·∫•t B·∫°i', 'Kh√¥ng th·ªÉ copy. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            } catch (err) {
                showCustomModal('Copy Th·∫•t B·∫°i', 'L·ªói khi copy: ' + err);
            } finally {
                document.body.removeChild(textarea);
            }
        }

        // --- Kh·ªüi t·∫°o M√†n h√¨nh L·ªãch l√†m vi·ªác ---
        function renderJobList() {
            jobList.innerHTML = '';
            jobs.sort((a, b) => {
                const dateA = new Date(`${a.scheduledDate}T${a.scheduledTime.split(' - ')[0]}`);
                const dateB = new Date(`${b.scheduledDate}T${b.scheduledTime.split(' - ')[0]}`);
                return dateA - dateB;
            }).forEach(job => {
                if (!jobStatus[job.id]) {
                    jobStatus[job.id] = {
                        status: 'pending',
                        checkinTime: null,
                        checkoutTime: null,
                        reportData: { notes: '', images: [], checklist: {}, materials: [] }
                    };
                }

                const jobItem = document.createElement('div');
                let statusBadge = '';
                const currentJobStatus = jobStatus[job.id].status;

                if (currentJobStatus === 'checkedIn') {
                    statusBadge = '<span class="ml-2 px-2 py-1 bg-yellow-200 text-yellow-800 text-xs font-semibold rounded-full">ƒêang th·ª±c hi·ªán</span>';
                } else if (currentJobStatus === 'checkedOut') {
                    statusBadge = '<span class="ml-2 px-2 py-1 bg-green-200 text-green-800 text-xs font-semibold rounded-full">ƒê√£ ho√†n th√†nh</span>';
                }

                jobItem.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-shadow';
                jobItem.innerHTML = `
                    <h3 class="text-lg font-semibold text-blue-700 flex items-center">${job.customerName}${statusBadge}</h3>
                    <p class="text-gray-600 text-sm mt-1 mb-2">
                        <i class="far fa-calendar-alt mr-1 text-gray-500"></i> ${job.scheduledDate.split('-').reverse().join('/')} -
                        <i class="far fa-clock mr-1 text-gray-500"></i> ${job.scheduledTime}
                        <span class="ml-3"><i class="fas fa-map-marker-alt mr-1 text-gray-500"></i> ${job.address}</span>
                    </p>
                    <p class="text-gray-700 text-sm"><strong class="text-gray-800">N·ªôi dung:</strong> ${job.content}</p>
                `;
                jobItem.addEventListener('click', () => {
                    initializeReportScreen(job);
                    showScreen('report-screen');
                });
                jobList.appendChild(jobItem);
            });
            renderDailyChemicalsSummary();
        }

        // --- Kh·ªüi t·∫°o M√†n h√¨nh B√°o c√°o C√¥ng t√°c Hi·ªán tr∆∞·ªùng (bao g·ªìm c·∫£ Chi ti·∫øt) ---
        function initializeReportScreen(job) {
            currentJob = job;
            const currentJobStatus = jobStatus[job.id].status;
            const reportData = jobStatus[job.id].reportData;

            reportJobId.textContent = job.id;
            reportCustomerNameDetail.textContent = job.customerName;
            reportAddressDetail.textContent = job.address;
            reportContentDetail.textContent = job.content;
            reportSpecialRequests.textContent = job.specialRequests;
            reportContactPerson.textContent = job.contactPerson;
            reportContactPhone.textContent = job.contactPhone;

            reportDetailChecklist.innerHTML = '';
            const checklistToDisplay = job.checklistItems && job.checklistItems.length > 0 ? job.checklistItems : [];
            if (checklistToDisplay.length > 0) {
                checklistToDisplay.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.textContent = item;
                    reportDetailChecklist.appendChild(listItem);
                });
            } else {
                reportDetailChecklist.innerHTML = '<li class="text-gray-500">Kh√¥ng c√≥ checklist cho c√¥ng vi·ªác n√†y.</li>';
            }

            reportRequiredChemicals.innerHTML = '';
            if (job.requiredChemicals && job.requiredChemicals.length > 0) {
                job.requiredChemicals.forEach(chem => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${chem.name}: ${chem.quantity} ${chem.unit}`;
                    reportRequiredChemicals.appendChild(listItem);
                });
            } else {
                reportRequiredChemicals.innerHTML = '<li class="text-gray-500">Kh√¥ng c√≥ h√≥a ch·∫•t c·∫ßn chu·∫©n b·ªã cho c√¥ng vi·ªác n√†y.</li>';
            }

            reportScreenTitle.textContent = (currentJobStatus === 'pending') ? 'Chi Ti·∫øt C√¥ng Vi·ªác' : 'B√°o C√°o C√¥ng T√°c';

            if (currentJobStatus === 'pending') {
                startJobButton.classList.remove('hidden');
                reportEditArea.classList.add('hidden');
            } else {
                startJobButton.classList.add('hidden');
                reportEditArea.classList.remove('hidden');
            }

            if (currentJobStatus === 'checkedIn') {
                checkoutButton.classList.remove('hidden');
                saveReportButton.classList.remove('hidden');
            } else {
                checkoutButton.classList.add('hidden');
                saveReportButton.classList.toggle('hidden', currentJobStatus === 'pending');
            }

            const isReportEditable = (currentJobStatus === 'checkedIn' || currentJobStatus === 'checkedOut');
            notesTextarea.disabled = !isReportEditable;
            uploadImageButton.disabled = !isReportEditable;
            microphoneButton.disabled = !isReportEditable;
            addMaterialButton.disabled = !isReportEditable;

            notesTextarea.value = reportData.notes;

            imagePreviewContainer.innerHTML = '';
            reportData.images.forEach(imgSrc => {
                const imgWrapper = document.createElement('div');
                imgWrapper.className = 'relative group';
                imgWrapper.innerHTML = `
                    <img src="${imgSrc}" class="w-full h-24 object-cover rounded-md shadow-sm" alt="·∫¢nh hi·ªán tr∆∞·ªùng">
                    <button class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity delete-image-btn" data-src="${imgSrc}" ${isReportEditable ? '' : 'disabled'}>
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        imagePreviewContainer.appendChild(imgWrapper);
            });

            renderInteractiveChecklist(reportData.checklist, isReportEditable);

            // C·∫≠p nh·∫≠t renderMaterialReportTable ƒë·ªÉ truy·ªÅn ƒë√∫ng d·ªØ li·ªáu h√≥a ch·∫•t y√™u c·∫ßu
            renderMaterialReportTable(job.requiredChemicals, reportData.materials, isReportEditable);
        }

        // --- X·ª≠ l√Ω n√∫t B·∫Øt ƒë·∫ßu C√¥ng vi·ªác (tr√™n m√†n h√¨nh B√°o c√°o) ---
        startJobButton.addEventListener('click', () => {
            if (!currentJob) return;

            const checkinTime = new Date().toLocaleString('vi-VN');
            jobStatus[currentJob.id].status = 'checkedIn';
            jobStatus[currentJob.id].checkinTime = checkinTime;

            showCustomModal('Check-in Th√†nh C√¥ng', `B·∫°n ƒë√£ check-in v√†o c√¥ng vi·ªác "${currentJob.customerName}" l√∫c ${checkinTime}. (T·ªça ƒë·ªô GPS s·∫Ω ƒë∆∞·ª£c ghi nh·∫≠n t·ª± ƒë·ªông)`);
            initializeReportScreen(currentJob);
            renderJobList();
        });

        // --- X·ª≠ l√Ω n√∫t G·ªçi ƒëi·ªán ---
        callPhoneButton.addEventListener('click', () => {
            const phoneNumber = reportContactPhone.textContent;
            copyToClipboard(phoneNumber, `ƒê√£ copy s·ªë ƒëi·ªán tho·∫°i: ${phoneNumber}`);
            window.location.href = `tel:${phoneNumber}`;
        });

        // --- X·ª≠ l√Ω n√∫t Zalo ---
        zaloPhoneButton.addEventListener('click', () => {
            const phoneNumber = reportContactPhone.textContent;
            copyToClipboard(phoneNumber, `ƒê√£ copy s·ªë ƒëi·ªán tho·∫°i Zalo: ${phoneNumber}`);
            const zaloNumber = phoneNumber.startsWith('0') ? phoneNumber.substring(1) : phoneNumber;
            window.open(`http://zalo.me/${zaloNumber}`, '_blank');
        });

        // --- X·ª≠ l√Ω ƒê√≠nh k√®m h√¨nh ·∫£nh ---
        uploadImageButton.addEventListener('click', () => {
            if (uploadImageButton.disabled) return;
            imageUploadInput.click();
        });

        imageUploadInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imgSrc = e.target.result;
                        const imgWrapper = document.createElement('div');
                        imgWrapper.className = 'relative group';
                        imgWrapper.innerHTML = `
                            <img src="${imgSrc}" class="w-full h-24 object-cover rounded-md shadow-sm" alt="·∫¢nh hi·ªán tr∆∞·ªùng">
                            <button class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity delete-image-btn" data-src="${imgSrc}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        imagePreviewContainer.appendChild(imgWrapper);
                        jobStatus[currentJob.id].reportData.images.push(imgSrc);
                    };
                    reader.readAsDataURL(file);
                }
                showCustomModal('·∫¢nh ƒê√£ Ch·ªçn', `ƒê√£ ch·ªçn ${files.length} ·∫£nh. ·∫¢nh s·∫Ω ƒë∆∞·ª£c t·ªëi ∆∞u v√† t·∫£i l√™n.`);
            }
        });

        // X√≥a ·∫£nh preview v√† c·∫≠p nh·∫≠t reportData
        imagePreviewContainer.addEventListener('click', (event) => {
            const btn = event.target.closest('.delete-image-btn');
            if (btn && !btn.disabled) {
                const imgSrcToRemove = btn.dataset.src;
                const index = jobStatus[currentJob.id].reportData.images.indexOf(imgSrcToRemove);
                if (index > -1) {
                    jobStatus[currentJob.id].reportData.images.splice(index, 1);
                }
                btn.parentElement.remove();
                showCustomModal('X√≥a ·∫£nh', '·∫¢nh ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi danh s√°ch.');
            }
        });

        // --- Render Checklist c√¥ng vi·ªác (phi√™n b·∫£n t∆∞∆°ng t√°c) ---
        function renderInteractiveChecklist(currentChecklistState = {}, isEditable = false) {
            checklistDiv.innerHTML = '';
            const checklistToRender = currentJob.checklistItems && currentJob.checklistItems.length > 0 ? currentJob.checklistItems : [];

            if (checklistToRender.length === 0) {
                 checklistDiv.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ checklist ƒë·ªÉ ƒë√°nh d·∫•u.</p>';
                 return;
            }

            checklistToRender.forEach((item, index) => {
                const checklistItem = document.createElement('div');
                checklistItem.className = 'flex items-center bg-gray-50 p-3 rounded-lg border border-gray-200';
                checklistItem.innerHTML = `
                    <input type="checkbox" id="report-checklist-item-${index}" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" ${isEditable ? '' : 'disabled'}>
                    <label for="report-checklist-item-${index}" class="ml-3 text-gray-700 font-medium">${item}</label>
                `;
                const checkbox = checklistItem.querySelector(`#report-checklist-item-${index}`);
                checkbox.checked = !!currentChecklistState[index];
                checkbox.addEventListener('change', () => {
                    if (isEditable) {
                        jobStatus[currentJob.id].reportData.checklist[index] = checkbox.checked;
                    }
                });
                checklistDiv.appendChild(checklistItem);
            });
        }

        // --- Render B√°o c√°o v·∫≠t t∆∞ (cho b·∫£ng ch√≠nh) ---
        function renderMaterialReportTable(requiredChemicals = [], savedMaterials = [], isEditable = false) {
            materialReportBody.innerHTML = '';

            const combinedMaterials = {};

            // Th√™m h√≥a ch·∫•t y√™u c·∫ßu tr∆∞·ªõc
            requiredChemicals.forEach(chem => {
                combinedMaterials[chem.name] = {
                    name: chem.name,
                    requiredQuantity: chem.quantity,
                    unit: chem.unit,
                    actualQuantity: null, // M·∫∑c ƒë·ªãnh s·ªë l∆∞·ª£ng th·ª±c t·∫ø l√† null
                    isCustom: false // Kh√¥ng ph·∫£i v·∫≠t t∆∞ t√πy ch·ªânh
                };
            });

            // Ghi ƒë√® b·∫±ng d·ªØ li·ªáu ƒë√£ l∆∞u ho·∫∑c th√™m v·∫≠t t∆∞ t√πy ch·ªânh
            savedMaterials.forEach(savedChem => {
                if (combinedMaterials[savedChem.name]) {
                    // N·∫øu l√† h√≥a ch·∫•t y√™u c·∫ßu ƒë√£ ƒë∆∞·ª£c l∆∞u, c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th·ª±c t·∫ø
                    combinedMaterials[savedChem.name].actualQuantity = savedChem.actualQuantity !== undefined ? savedChem.actualQuantity : savedChem.quantity;
                } else {
                    // ƒê√¢y l√† v·∫≠t t∆∞ t√πy ch·ªânh ƒë∆∞·ª£c th√™m v√†o
                    combinedMaterials[savedChem.name] = {
                        name: savedChem.name,
                        requiredQuantity: null, // Kh√¥ng c√≥ s·ªë l∆∞·ª£ng y√™u c·∫ßu cho v·∫≠t t∆∞ t√πy ch·ªânh
                        unit: savedChem.unit || '',
                        actualQuantity: savedChem.actualQuantity !== undefined ? savedChem.actualQuantity : savedChem.quantity,
                        isCustom: true
                    };
                }
            });

            const materialsToRender = Object.values(combinedMaterials);

            if (materialsToRender.length > 0) {
                materialsToRender.forEach(mat => addMaterialRowToTable(
                    mat.name,
                    mat.requiredQuantity,
                    mat.unit,
                    mat.actualQuantity,
                    mat.isCustom,
                    isEditable
                ));
            } else if (isEditable) {
                // N·∫øu kh√¥ng c√≥ h√≥a ch·∫•t y√™u c·∫ßu v√† c√≥ th·ªÉ ch·ªânh s·ª≠a, th√™m m·ªôt h√†ng tr·ªëng ƒë·ªÉ nh·∫≠p t√πy ch·ªânh
                addMaterialRowToTable('', null, '', null, true, isEditable);
            } else {
                materialReportBody.innerHTML = '<tr><td colspan="4" class="py-2 px-4 text-gray-500 text-center">Kh√¥ng c√≥ h√≥a ch·∫•t/v·∫≠t t∆∞ n√†o ƒë∆∞·ª£c s·ª≠ d·ª•ng.</td></tr>';
            }
        }

        // Helper function to add a row to the material report table
        function addMaterialRowToTable(name = '', requiredQuantity = null, unit = '', actualQuantity = null, isCustom = false, isEditable = false) {
            const newRow = document.createElement('tr');
            newRow.className = 'hover:bg-gray-50';
            newRow.innerHTML = `
                <td class="py-2 px-4 border-b">
                    <input type="text" value="${name}" placeholder="T√™n h√≥a ch·∫•t/v·∫≠t t∆∞" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-400 text-sm material-name-input" ${isEditable && isCustom ? '' : 'disabled'}>
                </td>
                <td class="py-2 px-4 border-b text-right">
                    <span class="text-gray-700 font-medium">${requiredQuantity !== null ? requiredQuantity + ' ' + unit : 'N/A'}</span>
                </td>
                <td class="py-2 px-4 border-b text-right">
                    <input type="number" value="${actualQuantity !== null ? actualQuantity : ''}" min="0" step="any" placeholder="0" class="w-20 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-400 text-sm text-right material-actual-quantity-input" ${isEditable ? '' : 'disabled'}>
                </td>
                <td class="py-2 px-4 border-b text-center">
                    <button class="remove-material-row bg-red-400 hover:bg-red-500 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center text-sm transition-colors shadow-sm" ${isEditable && isCustom ? '' : 'disabled'}>
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            materialReportBody.appendChild(newRow);

            const actualQuantityInput = newRow.querySelector('.material-actual-quantity-input');
            if (actualQuantityInput && isEditable) {
                actualQuantityInput.addEventListener('input', updateReportData);
            }

            const nameInput = newRow.querySelector('.material-name-input');
            if (nameInput && isEditable && isCustom) {
                 nameInput.addEventListener('input', updateReportData);
            }

            const removeButton = newRow.querySelector('.remove-material-row');
            if (removeButton && isEditable) {
                removeButton.addEventListener('click', (event) => {
                    event.target.closest('tr').remove();
                    updateReportData();
                });
            }
        }

        addMaterialButton.addEventListener('click', () => {
            if (currentJob && (jobStatus[currentJob.id].status === 'checkedIn' || jobStatus[currentJob.id].status === 'checkedOut')) {
                addMaterialRowToTable('', null, '', null, true, true);
                updateReportData();
            } else {
                showCustomModal('Th√¥ng b√°o', 'B·∫°n c·∫ßn check-in c√¥ng vi·ªác ƒë·ªÉ th√™m h√≥a ch·∫•t/v·∫≠t t∆∞.');
            }
        });

        function updateReportData() {
            if (!currentJob || !jobStatus[currentJob.id]) return;

            jobStatus[currentJob.id].reportData.notes = notesTextarea.value;

            const usedMaterials = [];
            materialReportBody.querySelectorAll('tr').forEach(row => {
                const nameInput = row.querySelector('.material-name-input');
                const actualQuantityInput = row.querySelector('.material-actual-quantity-input');
                const requiredQuantitySpan = row.querySelector('td:nth-child(2) span');
                const isCustom = nameInput.disabled === false;

                if (nameInput && actualQuantityInput && nameInput.value.trim() !== '') {
                    const requiredText = requiredQuantitySpan ? requiredQuantitySpan.textContent : 'N/A';
                    let requiredValue = null;
                    let unit = '';

                    if (requiredText !== 'N/A') {
                        const parts = requiredText.split(' ');
                        requiredValue = parseFloat(parts[0]);
                        unit = parts.slice(1).join(' ');
                    } else if (isCustom && actualQuantityInput.value.trim() !== '') {
                        unit = '';
                    }

                    usedMaterials.push({
                        name: nameInput.value.trim(),
                        requiredQuantity: requiredValue,
                        unit: unit,
                        actualQuantity: parseFloat(actualQuantityInput.value) || 0,
                        isCustom: isCustom
                    });
                }
            });
            jobStatus[currentJob.id].reportData.materials = usedMaterials;
        }

        saveReportButton.addEventListener('click', () => {
            if (currentJob && (jobStatus[currentJob.id].status === 'checkedIn' || jobStatus[currentJob.id].status === 'checkedOut')) {
                updateReportData();
                console.log('B√°o c√°o ƒë√£ ƒë∆∞·ª£c l∆∞u:', jobStatus[currentJob.id]);
                showTempNotification(`B√°o c√°o cho c√¥ng vi·ªác "${currentJob.customerName}" ƒë√£ ƒë∆∞·ª£c l∆∞u.`);
            } else {
                showCustomModal('Th√¥ng b√°o', 'B·∫°n c·∫ßn check-in c√¥ng vi·ªác ƒë·ªÉ l∆∞u b√°o c√°o.');
            }
        });

        checkoutButton.addEventListener('click', () => {
            if (currentJob && jobStatus[currentJob.id].status === 'checkedIn') {
                updateReportData();

                const checkoutTime = new Date().toLocaleString('vi-VN');
                jobStatus[currentJob.id].status = 'checkedOut';
                jobStatus[currentJob.id].checkoutTime = checkoutTime;

                console.log('B√°o c√°o c√¥ng t√°c ƒë√£ ho√†n th√†nh:', jobStatus[currentJob.id]);
                
                showCustomModal('Check-out Th√†nh C√¥ng', `B·∫°n ƒë√£ check-out kh·ªèi c√¥ng vi·ªác "${currentJob.customerName}" l√∫c ${checkoutTime}. B√°o c√°o ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.`);
                
                showScreen('schedule-screen');
                renderJobList();
            } else {
                showCustomModal('L·ªói', 'C√¥ng vi·ªác ch∆∞a ƒë∆∞·ª£c check-in ho·∫∑c ƒë√£ check-out.');
            }
        });

        backButton.addEventListener('click', () => {
            showScreen('schedule-screen');
        });

        notesTextarea.addEventListener('input', updateReportData);

        // --- Logic cho ph·∫ßn T·ªïng h√≥a ch·∫•t c·∫ßn l·∫•y trong ng√†y ---

        chemicalsSummaryHeader.addEventListener('click', () => {
            chemicalsSummaryContent.classList.toggle('expanded');
            const icon = chemicalsSummaryHeader.querySelector('i');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        });

        chemicalsCollectedCheckbox.addEventListener('change', () => {
            const today = getTodayDate();
            if (!dailyChemicalsStatus[today]) {
                dailyChemicalsStatus[today] = {};
            }
            if (chemicalsCollectedCheckbox.checked) {
                chemicalsNotesContainer.classList.add('hidden');
                chemicalsCollectionNotes.value = ''; // Clear notes if checked
                dailyChemicalsStatus[today].notes = ''; // Clear notes in data too
                dailyChemicalsStatus[today].status = 'confirmed'; // Update status
            } else {
                chemicalsNotesContainer.classList.remove('hidden');
                dailyChemicalsStatus[today].status = 'pending'; // Update status
            }
            // Update UI immediately
            updateDailyChemicalsSummaryUI();
        });

        chemicalsCollectionNotes.addEventListener('input', () => {
            const today = getTodayDate();
            if (!dailyChemicalsStatus[today]) {
                dailyChemicalsStatus[today] = {};
            }
            dailyChemicalsStatus[today].notes = chemicalsCollectionNotes.value;
        });

        saveDailyChemicalsStatusButton.addEventListener('click', () => {
            const today = getTodayDate();
            if (!dailyChemicalsStatus[today]) {
                dailyChemicalsStatus[today] = { status: 'pending', notes: '' };
            }
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i v√† ghi ch√∫ d·ª±a tr√™n checkbox
            dailyChemicalsStatus[today].collected = chemicalsCollectedCheckbox.checked;
            dailyChemicalsStatus[today].notes = chemicalsCollectionNotes.value;
            dailyChemicalsStatus[today].status = chemicalsCollectedCheckbox.checked ? 'confirmed' : 'pending';

            console.log('Tr·∫°ng th√°i h√≥a ch·∫•t trong ng√†y ƒë√£ l∆∞u:', dailyChemicalsStatus[today]);
            showTempNotification('ƒê√£ l∆∞u tr·∫°ng th√°i h√≥a ch·∫•t trong ng√†y.');

            // C·∫≠p nh·∫≠t UI sau khi l∆∞u
            updateDailyChemicalsSummaryUI();

            // T·ª± ƒë·ªông thu g·ªçn ph·∫ßn n√†y
            chemicalsSummaryContent.classList.remove('expanded');
            chemicalsSummaryHeader.querySelector('i').classList.remove('fa-chevron-up');
            chemicalsSummaryHeader.querySelector('i').classList.add('fa-chevron-down');
        });

        // H√†m c·∫≠p nh·∫≠t UI cho ph·∫ßn t·ªïng h√≥a ch·∫•t
        function updateDailyChemicalsSummaryUI() {
            const today = getTodayDate();
            const currentDayStatus = dailyChemicalsStatus[today] || { status: 'pending', notes: '' };

            chemicalsCollectedCheckbox.checked = currentDayStatus.status === 'confirmed';
            chemicalsCollectionNotes.value = currentDayStatus.notes;

            // V√¥ hi·ªáu h√≥a checkbox v√† ·∫©n n√∫t/ghi ch√∫ n·∫øu ƒë√£ x√°c nh·∫≠n
            chemicalsCollectedCheckbox.disabled = currentDayStatus.status === 'confirmed';
            saveDailyChemicalsStatusButton.disabled = currentDayStatus.status === 'confirmed';
            microphoneButton.disabled = currentDayStatus.status === 'confirmed'; // Assuming microphone is part of notes

            if (currentDayStatus.status === 'confirmed') {
                chemicalsNotesContainer.classList.add('hidden');
                saveDailyChemicalsStatusButton.classList.add('hidden');
                dailyChemicalsStatusText.textContent = '(ƒê√£ x√°c nh·∫≠n)';
                dailyChemicalsStatusText.classList.remove('text-gray-500');
                dailyChemicalsStatusText.classList.add('text-green-600');
            } else {
                chemicalsNotesContainer.classList.remove('hidden');
                saveDailyChemicalsStatusButton.classList.remove('hidden');
                dailyChemicalsStatusText.textContent = '(Ch∆∞a x√°c nh·∫≠n)';
                dailyChemicalsStatusText.classList.remove('text-green-600');
                dailyChemicalsStatusText.classList.add('text-gray-500');
            }
        }


        // Render daily chemicals summary
        function renderDailyChemicalsSummary() {
            dailyChemicalsList.innerHTML = '';
            const today = getTodayDate();

            const dailyChemicals = {};
            jobs.filter(job => job.scheduledDate === today).forEach(job => {
                job.requiredChemicals.forEach(chem => {
                    if (dailyChemicals[chem.name]) {
                        dailyChemicals[chem.name].quantity += chem.quantity;
                    } else {
                        dailyChemicals[chem.name] = { ...chem };
                    }
                });
            });

            if (Object.keys(dailyChemicals).length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside text-gray-700 space-y-1 pl-4';
                for (const name in dailyChemicals) {
                    const chem = dailyChemicals[name];
                    const listItem = document.createElement('li');
                    listItem.textContent = `${chem.name}: ${chem.quantity} ${chem.unit}`;
                    ul.appendChild(listItem);
                }
                dailyChemicalsList.appendChild(ul);
            } else {
                dailyChemicalsList.innerHTML = '<p class="text-gray-600">Kh√¥ng c√≥ h√≥a ch·∫•t c·∫ßn l·∫•y cho c√°c c√¥ng vi·ªác h√¥m nay.</p>';
            }

            // G·ªçi h√†m c·∫≠p nh·∫≠t UI ƒë·ªÉ load tr·∫°ng th√°i hi·ªán t·∫°i
            updateDailyChemicalsSummaryUI();
        }


        // Kh·ªüi t·∫°o ban ƒë·∫ßu
        renderJobList();
        showScreen('schedule-screen');
    </script>
</body>
</html>
