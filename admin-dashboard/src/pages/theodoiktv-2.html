<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Theo Dõi Phân Bổ Công Việc KTV - Sao Việt Pest</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cấu hình Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Tăng chiều cao tối đa cho bảng để hiển thị nhiều dòng hơn */
        .scrollable-table-container {
            max-height: 75vh; 
            overflow-y: auto;
        }
        /* Custom scrollbar for aesthetics */
        .scrollable-table-container::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-table-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        /* Cố định tiêu đề bảng */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3">Phân Bổ Công Việc Chi Tiết Kỹ Thuật Viên</h1>
        <p class="text-gray-500 mb-6">Theo dõi và so sánh chi tiết khối lượng công việc và quãng đường di chuyển của từng KTV trong tháng.</p>

        <!-- Thanh Lọc & Chỉ Số Tổng Quan -->
        <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-4 mb-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <!-- Bộ Lọc -->
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex flex-col">
                    <label for="month-filter" class="text-sm font-medium text-gray-700 mb-1">Tháng/Năm:</label>
                    <input type="month" id="month-filter" value="2025-10" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex flex-col">
                    <label for="team-filter" class="text-sm font-medium text-gray-700 mb-1">Đội/Nhóm:</label>
                    <select id="team-filter" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option>Tất cả</option>
                        <option>Đội 1 (TP.HCM)</option>
                        <option>Đội 2 (Hà Nội)</option>
                    </select>
                </div>
            </div>

            <!-- Chỉ Số Trung Bình (Hiển thị nhanh) -->
            <div class="flex flex-wrap gap-4 text-center">
                <div class="p-2 bg-white rounded-lg shadow-md border">
                    <p class="text-2xl font-semibold text-blue-600" id="avg-jobs">18.5</p>
                    <p class="text-xs text-gray-500">Việc TB/KTV</p>
                </div>
                <div class="p-2 bg-white rounded-lg shadow-md border">
                    <p class="text-2xl font-semibold text-blue-600" id="avg-km">320 Km</p>
                    <p class="text-xs text-gray-500">Km TB/KTV</p>
                </div>
            </div>
        </div>

        <!-- Bảng Dữ Liệu Chi Tiết - Đã được tăng cường -->
        <div class="bg-white rounded-xl shadow-lg border p-4">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Báo Cáo Phân Bổ Công Việc (Tháng 10/2025)</h2>
            
            <div class="scrollable-table-container border rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky-header">
                        <tr>
                            <!-- Cột cơ bản -->
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">STT</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Tên KTV</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Việc T9</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Việc T10</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-yellow-100">Chênh Lệch Việc</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Tỷ Lệ HT (%)</th>
                            
                            <!-- Cột Km -->
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Km T9</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Km T10</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-yellow-100">Chênh Lệch Km</th>
                            
                            <!-- Cột Hiệu suất/KPI mới -->
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-100">Thời Gian TB/Việc (Phút)</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-100">Số Lượng Hóa Chất Sử Dụng (L/Kg)</th>
                            
                            <!-- Cột Tình trạng -->
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Tình Trạng Phân Bổ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="ktv-data">
                        <!-- Dữ liệu mẫu sẽ được điền bằng JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // Dữ liệu mẫu cho KTV (Đã thêm chỉ số mới)
        const ktvData = [
            { id: 1, name: "Nguyễn Văn A", phone: "0901xxx111", jobs_prev: 19, jobs_current: 25, km_prev: 350, km_current: 480, completion_rate: 96, work_hours: 180, avg_time_per_job: 43, chemical_usage: 12.5 },
            { id: 2, name: "Trần Thị B", phone: "0902xxx222", jobs_prev: 18, jobs_current: 17, km_prev: 310, km_current: 290, completion_rate: 100, work_hours: 120, avg_time_per_job: 38, chemical_usage: 8.9 },
            { id: 3, name: "Lê Văn C", phone: "0903xxx333", jobs_prev: 20, jobs_current: 12, km_prev: 380, km_current: 210, completion_rate: 90, work_hours: 95, avg_time_per_job: 47, chemical_usage: 5.2 },
            { id: 4, name: "Phạm Thị D", phone: "0904xxx444", jobs_prev: 17, jobs_current: 22, km_prev: 280, km_current: 390, completion_rate: 98, work_hours: 150, avg_time_per_job: 41, chemical_usage: 10.1 },
            { id: 5, name: "Hoàng Minh E", phone: "0905xxx555", jobs_prev: 19, jobs_current: 19, km_prev: 320, km_current: 315, completion_rate: 95, work_hours: 135, avg_time_per_job: 45, chemical_usage: 9.8 },
            { id: 6, name: "Vũ Trọng F", phone: "0906xxx666", jobs_prev: 21, jobs_current: 27, km_prev: 400, km_current: 510, completion_rate: 99, work_hours: 190, avg_time_per_job: 42, chemical_usage: 13.0 },
            { id: 7, name: "Đặng Thu G", phone: "0907xxx777", jobs_prev: 16, jobs_current: 15, km_prev: 250, km_current: 260, completion_rate: 97, work_hours: 110, avg_time_per_job: 39, chemical_usage: 7.5 },
            { id: 8, name: "Tôn Thất H", phone: "0908xxx888", jobs_prev: 18, jobs_current: 18, km_prev: 300, km_current: 300, completion_rate: 96, work_hours: 125, avg_time_per_job: 40, chemical_usage: 9.1 },
            { id: 9, name: "Cao Thúy J", phone: "0909xxx999", jobs_prev: 15, jobs_current: 16, km_prev: 290, km_current: 280, completion_rate: 92, work_hours: 115, avg_time_per_job: 46, chemical_usage: 8.5 },
        ];

        // Tính toán các chỉ số trung bình và chênh lệch
        const totalJobs = ktvData.reduce((sum, item) => sum + item.jobs_current, 0);
        const totalKm = ktvData.reduce((sum, item) => sum + item.km_current, 0);
        const avgJobs = totalJobs / ktvData.length;
        const avgKm = totalKm / ktvData.length;

        // Cập nhật chỉ số trung bình trên dashboard
        document.getElementById('avg-jobs').textContent = avgJobs.toFixed(1);
        document.getElementById('avg-km').textContent = `${avgKm.toFixed(0)} Km`;

        // Hàm xác định trạng thái dựa trên sự chênh lệch
        function getStatus(valueJobs, avgJobs, valueKm, avgKm, thresholdJobs = 4, thresholdKm = 100) {
            const diffJobs = valueJobs - avgJobs;
            const diffKm = valueKm - avgKm;
            
            let statusText, statusClass;

            const isBalanced = (Math.abs(diffJobs) <= thresholdJobs) && (Math.abs(diffKm) <= thresholdKm);

            if (isBalanced) {
                statusText = "Cân Bằng";
                statusClass = "bg-green-100 text-green-800";
            } else if (diffJobs > thresholdJobs || diffKm > thresholdKm) {
                statusText = "Quá Tải (Việc/Km Cao)";
                statusClass = "bg-red-100 text-red-800";
            } else {
                statusText = "Ít Việc (Cần Phân Bổ)";
                statusClass = "bg-yellow-100 text-yellow-800";
            }

            return { diffJobs: diffJobs.toFixed(0), diffKm: diffKm.toFixed(0), statusText, statusClass };
        }

        // Điền dữ liệu vào bảng
        const tableBody = document.getElementById('ktv-data');
        ktvData.forEach((ktv, index) => {
            const { diffJobs, diffKm, statusText, statusClass } = getStatus(ktv.jobs_current, avgJobs, ktv.km_current, avgKm);
            
            // Xử lý màu sắc cho cột chênh lệch
            const diffJobsClass = diffJobs > 0 ? 'text-red-600 font-bold' : (diffJobs < 0 ? 'text-green-600' : 'text-gray-500');
            const diffKmClass = diffKm > 0 ? 'text-red-600 font-bold' : (diffKm < 0 ? 'text-green-600' : 'text-gray-500');

            const row = document.createElement('tr');
            row.classList.add(index % 2 === 0 ? 'bg-white' : 'bg-gray-50', 'hover:bg-gray-100', 'transition', 'duration-150');

            row.innerHTML = `
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 font-medium">${index + 1}</td>
                <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-blue-600">${ktv.name}</td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-center">${ktv.jobs_prev}</td>
                <td class="px-3 py-2 whitespace-nowrap text-sm font-semibold text-gray-800 text-center">${ktv.jobs_current}</td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-center font-semibold ${diffJobsClass}">
                    ${diffJobs > 0 ? `+${diffJobs}` : diffJobs}
                </td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-center">${ktv.completion_rate}%</td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-center">${ktv.km_prev}</td>
                <td class="px-3 py-2 whitespace-nowrap text-sm font-semibold text-gray-800 text-center">${ktv.km_current}</td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-center font-semibold ${diffKmClass}">
                    ${diffKm > 0 ? `+${diffKm}` : diffKm}
                </td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-800 text-center font-medium">${ktv.avg_time_per_job} phút</td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-800 text-center font-medium">${ktv.chemical_usage.toFixed(1)}</td>
                <td class="px-3 py-2 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                        ${statusText}
                    </span>
                </td>
            `;
            tableBody.appendChild(row);
        });
    </script>
</body>
</html>
