# Tóm Tắt Thay Đổi Migration và Code

**File này tóm tắt tất cả thay đổi đã thực hiện để hợp nhất bảng [`jobs`](admin-dashboard/src/pages/DanhSachCongViec.js ) và `scheduled_jobs` thành bảng [`jobs`](admin-dashboard/src/pages/DanhSachCongViec.js ) thống nhất, cùng với cập nhật code JS. Sử dụng để tham khảo nếu gặp lỗi SQL hoặc cần rollback/debug.**

## 1. Thay Đổi Schema SQL

### Bảng [`jobs`](admin-dashboard/src/pages/DanhSachCongViec.js ) Mới (Thống Nhất)
- **Trước**: [`jobs`](admin-dashboard/src/pages/DanhSachCongViec.js ) (id bigint), `scheduled_jobs` (id UUID) riêng biệt.
- **Sau**: [`jobs`](admin-dashboard/src/pages/DanhSachCongViec.js ) thống nhất (id UUID), hợp nhất từ cả hai bảng.
- **Trường mới thêm**:
  - `customer_name` (TEXT)
  - `assigned_technicians` (JSONB, mặc định [])
  - `start_time` (TIME, mặc định '08:00')
  - `end_time` (TIME, mặc định '10:00')
  - `is_deleted` (BOOLEAN, mặc định FALSE)
  - `delete_note` (TEXT)
  - `service_content` (TEXT)
  - `updated_at` (TIMESTAMP, với trigger)
- **Thay đổi kiểu**: [`id`](admin-dashboard/src/pages/DanhSachCongViec.js ) từ bigint sang UUID, `checklist` từ text[] sang JSONB, `user_id` thành `created_by`.
- **Constraint**: Mở rộng check status bao gồm 'Hoàn thành'.

### Bảng Liên Quan (job_assignments, job_materials, job_checklist_items, work_reports)
- **Trước**: `job_id` bigint, FK đến jobs cũ.
- **Sau**: `job_id` UUID, FK đến jobs mới.
- **Thay đổi**: Migration mapping từ job_id cũ (bigint) sang mới (UUID) qua bảng tạm `temp_job_mapping`.

### Migration Script (tong_hop_migration_final.sql)
- Tạo `jobs_new` với schema mới.
- Insert từ [`jobs`](admin-dashboard/src/pages/DanhSachCongViec.js ) cũ (gen UUID mới, lưu mapping).
- Insert từ `scheduled_jobs` (giữ id UUID).
- Update `job_id` trong bảng con qua mapping.
- Rename và drop bảng cũ.
- **Lưu ý**: Sử dụng CASCADE cho DROP COLUMN/FK nếu có RLS dependencies.

## 2. Thay Đổi Code JS

### LapKeHoachGiaoViec.js
- **Thay đổi**: Thay tất cả query `scheduled_jobs` bằng [`jobs`](admin-dashboard/src/pages/DanhSachCongViec.js ).
- **Insert/Update**: Thêm trường mới (`start_time`, `end_time`, `assigned_technicians` JSONB, `is_deleted`, `delete_note`, `service_content`).
- **Ví dụ**:
  ```javascript
  await supabase.from('jobs').insert({
    // ... trường cũ
    start_time: '08:00',
    end_time: '10:00',
    assigned_technicians: [],
    is_deleted: false,
    service_content: taskContent
  });
  ```

### LapKeHoachCongViec.js
- **Thay đổi**: Gần như không đổi (đã dùng [`jobs`](admin-dashboard/src/pages/DanhSachCongViec.js )), nhưng thêm `assigned_technicians` JSONB nếu phân công bulk.
- **Insert**: Thêm `start_time`, `end_time` nếu có.

### [`admin-dashboard/src/pages/DanhSachCongViec.js`](admin-dashboard/src/pages/DanhSachCongViec.js )
- **Thay đổi**: Update query [`jobs`](admin-dashboard/src/pages/DanhSachCongViec.js ) với JOIN [`job_assignments`](admin-dashboard/src/pages/DanhSachCongViec.js ), thêm filter `is_deleted: false`.
- **Ví dụ**:
  ```javascript
  const { data } = await supabase
    .from('jobs')
    .select(`*, job_assignments (technician_id, role, status)`)
    .eq('is_deleted', false)
    .order('scheduled_date', { ascending: false });
  ```

## 3. Lưu Ý Quan Trọng
- **Backup**: Luôn backup DB trước migration.
- **Rollback**: Nếu lỗi, DROP [`jobs`](admin-dashboard/src/pages/DanhSachCongViec.js ), RENAME `jobs_old` thành [`jobs`](admin-dashboard/src/pages/DanhSachCongViec.js ), recreate FK.
- **RLS Policies**: Recreate nếu bị xóa (ví dụ: `CREATE POLICY "Users can manage..." ON job_materials FOR ALL USING (auth.uid() = user_id);`).
- **Test**: Kiểm tra insert/update/delete, đảm bảo `job_id` UUID.
- **Lỗi Thường Gặp**:
  - UUID cast: Sử dụng mapping hoặc ALTER TYPE.
  - FK conflict: Drop FK trước, add lại sau.
  - RLS: Sử dụng CASCADE khi DROP.

**Ngày cập nhật cuối**: October 6, 2025. Nếu gặp lỗi, cung cấp log và đọc lại file này để debug.

## 4. Hợp Nhất Profiles và Technicians (Tránh Trùng Lặp)

### Lý Do
- Bảng `profiles` và `technicians` lưu trùng lặp thông tin user (name, phone, position/role).
- Để tối ưu, hợp nhất `technicians` vào `profiles`, dùng `role_id` để phân biệt kỹ thuật viên.

### Thay Đổi Schema
- **Thêm cột vào `profiles`**:
  - `tech_code` (TEXT, nullable)
  - `email` (TEXT, nullable)
- **Migrate data**: Copy `tech_code` và `email` từ `technicians` sang `profiles` dựa trên `user_id`.
- **Update role**: Set `role_id` = 'technician' cho users có trong `technicians`.
- **Tạo lại view `technician_users`**: Từ `profiles` thay vì join `technicians`.
- **Drop bảng `technicians`**: Sau khi migrate.

### Code SQL (Đã Chạy)
```sql
-- Thêm cột
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS tech_code TEXT NULL;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS email TEXT NULL;

-- Migrate data
UPDATE public.profiles 
SET tech_code = t.tech_code, email = t.email
FROM public.technicians t
WHERE profiles.id = t.user_id;

-- Set role
UPDATE public.profiles 
SET role_id = (SELECT id FROM public.roles WHERE name = 'technician')
WHERE id IN (SELECT user_id FROM public.technicians WHERE active = true);

-- Tạo view
DROP VIEW IF EXISTS public.technician_users;
CREATE VIEW public.technician_users AS
SELECT 
  p.id AS technician_id,
  p.id AS user_id,
  p.tech_code,
  p.name,
  p.email,
  p.phone,
  true AS active,
  au.email AS auth_email,
  au.raw_user_meta_data ->> 'full_name'::text AS full_name
FROM public.profiles p
JOIN auth.users au ON p.id = au.id
WHERE p.role_id = (SELECT id FROM public.roles WHERE name = 'technician') AND p.active = true;

-- Drop technicians
DROP TABLE IF EXISTS public.technicians CASCADE;
```

### Thay Đổi Code JS
- **RoleManagement.js**: Đã tạo trang quản lý roles/permissions.
- **Các file khác**: Update nếu dùng `technicians`, chuyển sang dùng `profiles` với `role_id`.

## 5. Hệ Thống Roles và Permissions

### Lý Do
- Cần phân quyền rõ ràng thay vì hardcode.
- Dùng bảng `roles`, `permissions`, `role_permissions` để quản lý.

### Schema Mới
- **Bảng `roles`**: id (UUID), name (TEXT), description (TEXT).
- **Bảng `permissions`**: id (UUID), name (TEXT), description (TEXT).
- **Bảng `role_permissions`**: role_id (FK), permission_id (FK).
- **Cập nhật `profiles`**: Thêm `role_id` (FK đến roles).

### Data Mẫu
- Roles: admin, technician, manager.
- Permissions: create_job, edit_job, delete_job, view_jobs, etc.
- Gán permissions cho roles.

### RLS Policies
- Dùng function `has_permission(user_id, permission_name)` để check quyền.
- Ví dụ: Policy cho `job_materials` chỉ cho phép nếu user có permission 'create_job'.

### Code JS
- **RoleManagement.js**: Trang quản lý roles/permissions.
- **Check quyền**: Trong component, dùng `has_permission` hoặc check role.

### Lưu Ý
- Backup DB trước khi chạy.
- Test RLS sau khi tạo policies.
- Nếu rollback, drop tables roles/permissions và revert profiles.role_id.